<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How are categorical predictors handled in <code>recipes</code>? • recipes</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">recipes</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/Simple_Example.html">Simple Example</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Selecting_Variables.html">Selecting Variables</a>
    </li>
    <li>
      <a href="../articles/Custom_Steps.html">Custom Steps</a>
    </li>
    <li>
      <a href="../articles/Ordering.html">The Order of Steps</a>
    </li>
    <li>
      <a href="../articles/Dummies.html">Dummy Variables and Interactions</a>
    </li>
    <li>
      <a href="../articles/Skipping.html">On Skipping Steps</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/topepo/recipes">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>How are categorical predictors handled in <code>recipes</code>?</h1>
            
          </div>

    
    
<div class="contents">
<p>Recipes can be different from their base R counterparts such as <code>model.matrix</code>. This vignette describes the different methods for encoding categorical predictors with special attention to interaction terms.</p>
<div id="creating-dummy-variables" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-dummy-variables" class="anchor"></a>Creating Dummy Variables</h2>
<p>Let’s start, of course, with <code>iris</code> data. This has four numeric columns and a single factor column with three levels: <code>'setosa'</code>, <code>'versicolor'</code>, and <code>'virginica'</code>. Our initial recipe will have no outcome:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(recipes)
iris_rec &lt;-<span class="st"> </span><span class="kw"><a href="../reference/recipe.html">recipe</a></span>( <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> iris)
<span class="kw">summary</span>(iris_rec)
<span class="co">#&gt; # A tibble: 5 x 4</span>
<span class="co">#&gt;       variable    type      role   source</span>
<span class="co">#&gt;          &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;</span>
<span class="co">#&gt; 1 Sepal.Length numeric predictor original</span>
<span class="co">#&gt; 2  Sepal.Width numeric predictor original</span>
<span class="co">#&gt; 3 Petal.Length numeric predictor original</span>
<span class="co">#&gt; 4  Petal.Width numeric predictor original</span>
<span class="co">#&gt; 5      Species nominal predictor original</span></code></pre></div>
<p>A <a href="https://en.wikipedia.org/wiki/Contrast_(statistics)">contrast function</a> in R is a method for translating a column with categorical values into one or more numeric columns that take the place of the original. This can also be known as an encoding method or a parameterization function.</p>
<p>The default approach is to create dummy variables using the “reference cell” parameterization. This means that, if there are <em>C</em> levels of the factor, there will be <em>C</em> - 1 dummy variables created and all but the first factor level are made into new columns:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ref_cell &lt;-<span class="st"> </span>iris_rec <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/step_dummy.html">step_dummy</a></span>(Species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/prep.html">prep</a></span>(<span class="dt">training =</span> iris, <span class="dt">retain =</span> <span class="ot">TRUE</span>)
<span class="kw">summary</span>(ref_cell)
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;             variable    type      role   source</span>
<span class="co">#&gt;                &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;</span>
<span class="co">#&gt; 1       Sepal.Length numeric predictor original</span>
<span class="co">#&gt; 2        Sepal.Width numeric predictor original</span>
<span class="co">#&gt; 3       Petal.Length numeric predictor original</span>
<span class="co">#&gt; 4        Petal.Width numeric predictor original</span>
<span class="co">#&gt; 5 Species_versicolor numeric predictor  derived</span>
<span class="co">#&gt; 6  Species_virginica numeric predictor  derived</span>

<span class="co"># Get a row for each factor level</span>
rows &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">51</span>, <span class="dv">101</span>)
<span class="kw"><a href="../reference/juice.html">juice</a></span>(ref_cell, <span class="kw">starts_with</span>(<span class="st">"Species"</span>))[rows,]
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   Species_versicolor Species_virginica</span>
<span class="co">#&gt;                &lt;dbl&gt;             &lt;dbl&gt;</span>
<span class="co">#&gt; 1                  0                 0</span>
<span class="co">#&gt; 2                  1                 0</span>
<span class="co">#&gt; 3                  0                 1</span></code></pre></div>
<p>Note that the original column (<code>Species</code>) is no longer there.</p>
<p>There are different types of contrasts that can be used for different types of factors. The defaults are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">param &lt;-<span class="st"> </span><span class="kw">getOption</span>(<span class="st">"contrasts"</span>)
param
<span class="co">#&gt;         unordered           ordered </span>
<span class="co">#&gt; "contr.treatment"      "contr.poly"</span></code></pre></div>
<p>Looking at <code>?contrast</code>, there are other options. One alternative is the little known Helmert contrast:</p>
<blockquote>
<p><code>contr.helmert</code> returns Helmert contrasts, which contrast the second level with the first, the third with the average of the first two, and so on.</p>
</blockquote>
<p>To get this encoding, the global option for the contrasts can be changed and saved. <a href="https://topepo.github.io/recipes/reference/step_dummy.html"><code>step_dummy</code></a> picks up on this and makes the correct calculations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># change it:</span>
new_cont &lt;-<span class="st"> </span>param
new_cont[<span class="st">"unordered"</span>] &lt;-<span class="st"> "contr.helmert"</span>
<span class="kw">options</span>(<span class="dt">contrasts =</span> new_cont)

<span class="co"># now make dummy variables with new parameterization</span>
helmert &lt;-<span class="st"> </span>iris_rec <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/step_dummy.html">step_dummy</a></span>(Species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/prep.html">prep</a></span>(<span class="dt">training =</span> iris, <span class="dt">retain =</span> <span class="ot">TRUE</span>)
<span class="kw">summary</span>(helmert)
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;       variable    type      role   source</span>
<span class="co">#&gt;          &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;</span>
<span class="co">#&gt; 1 Sepal.Length numeric predictor original</span>
<span class="co">#&gt; 2  Sepal.Width numeric predictor original</span>
<span class="co">#&gt; 3 Petal.Length numeric predictor original</span>
<span class="co">#&gt; 4  Petal.Width numeric predictor original</span>
<span class="co">#&gt; 5   Species_X1 numeric predictor  derived</span>
<span class="co">#&gt; 6   Species_X2 numeric predictor  derived</span>

<span class="kw"><a href="../reference/juice.html">juice</a></span>(helmert, <span class="kw">starts_with</span>(<span class="st">"Species"</span>))[rows,]
<span class="co">#&gt; # A tibble: 3 x 2</span>
<span class="co">#&gt;   Species_X1 Species_X2</span>
<span class="co">#&gt;        &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="co">#&gt; 1         -1         -1</span>
<span class="co">#&gt; 2          1         -1</span>
<span class="co">#&gt; 3          0          2</span>

<span class="co"># Yuk; go back to the original method</span>
<span class="kw">options</span>(<span class="dt">contrasts =</span> param)</code></pre></div>
</div>
<div id="interactions-with-dummy-variables" class="section level2">
<h2 class="hasAnchor">
<a href="#interactions-with-dummy-variables" class="anchor"></a>Interactions with Dummy Variables</h2>
<p>Creating interactions with recipes requires the use of a model formula, such as</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">iris_int &lt;-<span class="st"> </span>iris_rec <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/step_interact.html">step_interact</a></span>( <span class="op">~</span><span class="st"> </span>Sepal.Width<span class="op">:</span>Sepal.Length) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/prep.html">prep</a></span>(<span class="dt">training =</span> iris, <span class="dt">retain =</span> <span class="ot">TRUE</span>)
<span class="kw">summary</span>(iris_int)
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;                     variable    type      role   source</span>
<span class="co">#&gt;                        &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;</span>
<span class="co">#&gt; 1               Sepal.Length numeric predictor original</span>
<span class="co">#&gt; 2                Sepal.Width numeric predictor original</span>
<span class="co">#&gt; 3               Petal.Length numeric predictor original</span>
<span class="co">#&gt; 4                Petal.Width numeric predictor original</span>
<span class="co">#&gt; 5                    Species nominal predictor original</span>
<span class="co">#&gt; 6 Sepal.Width_x_Sepal.Length numeric predictor  derived</span></code></pre></div>
<p>In <a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/formula.html">R model formulae</a>, using a <code>*</code> between two variables would expand to <code>a*b = a + b + a:b</code> so that the main effects are included. In <a href="https://topepo.github.io/recipes/reference/step_interact.html"><code>step_interact</code></a>, you can do use <code>*</code>, but only the interactions are recorded as columns that needs to be created.</p>
<p>One thing that <code>recipes</code> does differently than base R is to construct the design matrix in sequential iterations. This is relevant when thinking about interactions between continuous and categorical predictors.</p>
<p>For example, if you were to use the standard formula interface, the creation of the dummy variables happens at the same time as the interactions are created:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">model.matrix</span>(<span class="op">~</span><span class="st"> </span>Species<span class="op">*</span>Sepal.Length, <span class="dt">data =</span> iris)[rows,]
<span class="co">#&gt;     (Intercept) Speciesversicolor Speciesvirginica Sepal.Length</span>
<span class="co">#&gt; 1             1                 0                0          5.1</span>
<span class="co">#&gt; 51            1                 1                0          7.0</span>
<span class="co">#&gt; 101           1                 0                1          6.3</span>
<span class="co">#&gt;     Speciesversicolor:Sepal.Length Speciesvirginica:Sepal.Length</span>
<span class="co">#&gt; 1                                0                           0.0</span>
<span class="co">#&gt; 51                               7                           0.0</span>
<span class="co">#&gt; 101                              0                           6.3</span></code></pre></div>
<p>With recipes, you create them sequentially. This raises an issue: do I have to type out all of the interaction effects by their specific names when using dummy variable?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Must I do this?</span>
iris_rec <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/step_interact.html">step_interact</a></span>( <span class="op">~</span><span class="st"> </span>Species_versicolor<span class="op">:</span>Sepal.Length <span class="op">+</span><span class="st"> </span>
<span class="st">                   </span>Species_virginica<span class="op">:</span>Sepal.Length) </code></pre></div>
<p>Note only is this a pain, but it may not be obvious what dummy variables are available (especially when <a href="https://topepo.github.io/recipes/reference/step_other.html"><code>step_other</code></a> is used).</p>
<p>The solution is to use a selector:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">iris_int &lt;-<span class="st"> </span>iris_rec <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/step_dummy.html">step_dummy</a></span>(Species) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/step_interact.html">step_interact</a></span>( <span class="op">~</span><span class="st"> </span><span class="kw">starts_with</span>(<span class="st">"Species"</span>)<span class="op">:</span>Sepal.Length) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/prep.html">prep</a></span>(<span class="dt">training =</span> iris, <span class="dt">retain =</span> <span class="ot">TRUE</span>)
<span class="kw">summary</span>(iris_int)
<span class="co">#&gt; # A tibble: 8 x 4</span>
<span class="co">#&gt;                            variable    type      role   source</span>
<span class="co">#&gt;                               &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;</span>
<span class="co">#&gt; 1                      Sepal.Length numeric predictor original</span>
<span class="co">#&gt; 2                       Sepal.Width numeric predictor original</span>
<span class="co">#&gt; 3                      Petal.Length numeric predictor original</span>
<span class="co">#&gt; 4                       Petal.Width numeric predictor original</span>
<span class="co">#&gt; 5                Species_versicolor numeric predictor  derived</span>
<span class="co">#&gt; 6                 Species_virginica numeric predictor  derived</span>
<span class="co">#&gt; 7 Species_versicolor_x_Sepal.Length numeric predictor  derived</span>
<span class="co">#&gt; 8  Species_virginica_x_Sepal.Length numeric predictor  derived</span></code></pre></div>
<p>What happens here is that <code>starts_with("Species")</code> is executed on the data that are available when the previous steps have been applied to the data. That means that the dummy variable columns are present. The results of this selectors are then translated to an additive function of the results. In this case, that means that</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">starts_with</span>(<span class="st">"Species"</span>)</code></pre></div>
<p>becomes</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(Species_versicolor <span class="op">+</span><span class="st"> </span>Species_virginica)</code></pre></div>
<p>The entire interaction formula is shown here:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">iris_int
<span class="co">#&gt; Data Recipe</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Inputs:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;       role #variables</span>
<span class="co">#&gt;  predictor          5</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Training data contained 150 data points and no missing data.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Steps:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dummy variables from Species [trained]</span>
<span class="co">#&gt; Interactions with (Species_versicolor + Species_virginica):Sepal.Length [trained]</span></code></pre></div>
</div>
<div id="warning" class="section level2">
<h2 class="hasAnchor">
<a href="#warning" class="anchor"></a>Warning!</h2>
<p>Would it work if I didn’t convert species to a factor and used the interactions step?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">iris_int &lt;-<span class="st"> </span>iris_rec <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/step_interact.html">step_interact</a></span>( <span class="op">~</span><span class="st"> </span>Species<span class="op">:</span>Sepal.Length) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/prep.html">prep</a></span>(<span class="dt">training =</span> iris, <span class="dt">retain =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Warning in prep.step_interact(x$steps[[i]], training = training, info = x</span>
<span class="co">#&gt; $term_info): Categorical variables used in `step_interact` should probably</span>
<span class="co">#&gt; be avoided; This can lead to differences in dummy variable values that are</span>
<span class="co">#&gt; produced by `step_dummy`.</span>
<span class="kw">summary</span>(iris_int)
<span class="co">#&gt; # A tibble: 7 x 4</span>
<span class="co">#&gt;                           variable    type      role   source</span>
<span class="co">#&gt;                              &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;</span>
<span class="co">#&gt; 1                     Sepal.Length numeric predictor original</span>
<span class="co">#&gt; 2                      Sepal.Width numeric predictor original</span>
<span class="co">#&gt; 3                     Petal.Length numeric predictor original</span>
<span class="co">#&gt; 4                      Petal.Width numeric predictor original</span>
<span class="co">#&gt; 5                          Species nominal predictor original</span>
<span class="co">#&gt; 6 Speciesversicolor_x_Sepal.Length numeric predictor  derived</span>
<span class="co">#&gt; 7  Speciesvirginica_x_Sepal.Length numeric predictor  derived</span></code></pre></div>
<p>The columns <code>Species</code> isn’t affected and a warning is issued. Basically, you only get half of what <code>model.matrix</code> does and that could really be problematic in subsequent steps.</p>
</div>
<div id="other-steps-related-to-dummy-variables" class="section level2">
<h2 class="hasAnchor">
<a href="#other-steps-related-to-dummy-variables" class="anchor"></a>Other Steps Related to Dummy Variables</h2>
<p>There are a bunch of steps related to going in-between factors and dummy variables:</p>
<ul>
<li>
<a href="https://topepo.github.io/recipes/reference/step_other.html"><code>step_other</code></a> can collapse infrequently occurring levels into <code>'other'</code>.</li>
<li>
<a href="https://topepo.github.io/recipes/reference/step_regex.html"><code>step_regex</code></a> will create a single dummy variable based on applying a regular expression to a text field. Similarly, <a href="https://topepo.github.io/recipes/reference/step_count.html"><code>step_count</code></a> does the same but counts the occurrences of the pattern in the string.</li>
<li>
<a href="https://topepo.github.io/recipes/reference/step_holiday.html"><code>step_holiday</code></a> creates dummy variables from date fields to capture holidays.</li>
<li>
<a href="https://topepo.github.io/recipes/reference/step_lincomb.html"><code>step_lincomb</code></a> can be useful if you <em>over-specify</em> interactions and need to remove linear dependencies.</li>
<li>
<a href="https://topepo.github.io/recipes/reference/step_zv.html"><code>step_zv</code></a> can remove dummy variables that never show a 1 in the column (i.e. is zero-variance).</li>
</ul>
<p><a href="https://topepo.github.io/recipes/reference/step_dummy.html"><code>step_dummy</code></a> also works with <em>ordered factors</em>. As seen above, the default encoding is to create a series of polynomial variables. There are also a few steps for ordered factors:</p>
<ul>
<li>
<a href="https://topepo.github.io/recipes/reference/step_ordinalscore.html"><code>step_ordinalscore</code></a> can translate the levels to a single numeric score.</li>
<li>
<a href="https://topepo.github.io/recipes/reference/step_unorder.html"><code>step_unorder</code></a> can convert to an unordered factor.</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#creating-dummy-variables">Creating Dummy Variables</a></li>
      <li><a href="#interactions-with-dummy-variables">Interactions with Dummy Variables</a></li>
      <li><a href="#warning">Warning!</a></li>
      <li><a href="#other-steps-related-to-dummy-variables">Other Steps Related to Dummy Variables</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Max Kuhn, <a href="http://hadley.nz">Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
